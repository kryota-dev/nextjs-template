name: ğŸš€ è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: ğŸš€ ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      issues: write

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: ğŸ”¨ pnpmã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: ./.github/actions/pnpm-setup

      - name: ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ç”Ÿæˆ
        id: calendar-version
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const logger = {
              info: (msg) => console.log(`[INFO] ğŸ”µ ${msg}`),
              warn: (msg) => console.warn(`[WARN] ğŸŸ¡ ${msg}`),
              error: (msg) => console.error(`[ERROR] ğŸ”´ ${msg}`),
              success: (msg) => console.log(`[SUCCESS] ğŸŸ¢ ${msg}`)
            };

            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’YYYY.MM.DDå½¢å¼ã§å–å¾—
            const today = new Date().toISOString().split('T')[0].replace(/-/g, '.');
            logger.info(`ä»Šæ—¥ã®æ—¥ä»˜: ${today}`);

            // æ—¢å­˜ã®ã‚¿ã‚°ä¸€è¦§ã‚’å–å¾—
            const existingTags = await github.paginate(github.rest.repos.listTags, {
              owner: context.repo.owner,
              repo: context.repo.repo
            }).catch(error => {
              logger.error(`ã‚¿ã‚°ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error}`);
              throw error;
            });

            // ä»Šæ—¥ã®æ—¥ä»˜ã§å§‹ã¾ã‚‹ã‚¿ã‚°ã‚’æ¤œç´¢
            const todayTags = existingTags.filter(tag => tag.name.startsWith(today));
            logger.info(`ä»Šæ—¥ã®ã‚¿ã‚°æ•°: ${todayTags.length}`);

            // æ–°ã—ã„ã‚¿ã‚°åã‚’æ±ºå®š
            let newTag = today;
            if (todayTags.length > 0) {
              // åŒæ—¥ã«è¤‡æ•°ã®ãƒªãƒªãƒ¼ã‚¹ãŒã‚ã‚‹å ´åˆã€ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ 
              const maxCount = Math.max(...todayTags.map(tag => {
                const parts = tag.name.split('-');
                return parts.length > 1 ? parseInt(parts[1]) || 0 : 0;
              }));
              newTag = `${today}-${maxCount + 1}`;
            }

            logger.success(`æ–°ã—ã„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°: ${newTag}`);
            core.setOutput('tag', newTag);
            return newTag;

      - name: ğŸ” Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›´ãƒã‚§ãƒƒã‚¯
        id: nextjs-version
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const logger = {
              info: (msg) => console.log(`[INFO] ğŸ”µ ${msg}`),
              warn: (msg) => console.warn(`[WARN] ğŸŸ¡ ${msg}`),
              error: (msg) => console.error(`[ERROR] ğŸ”´ ${msg}`),
              success: (msg) => console.log(`[SUCCESS] ğŸŸ¢ ${msg}`)
            };

            const fs = require('fs');
            const { execSync } = require('child_process');

            try {
              // ç¾åœ¨ã®package.jsonã‹ã‚‰Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
              const currentPackageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              const currentNextjsVersion = currentPackageJson.dependencies.next;
              const currentMajor = parseInt(currentNextjsVersion.split('.')[0]);
              
              logger.info(`ç¾åœ¨ã®Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${currentNextjsVersion} (ãƒ¡ã‚¸ãƒ£ãƒ¼: ${currentMajor})`);

              // å‰å›ã‚³ãƒŸãƒƒãƒˆã®package.jsonã‹ã‚‰Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
              let previousNextjsVersion = null;
              let previousMajor = null;
              
              try {
                const previousPackageJsonContent = execSync('git show HEAD~1:package.json', { encoding: 'utf8' });
                const previousPackageJson = JSON.parse(previousPackageJsonContent);
                previousNextjsVersion = previousPackageJson.dependencies.next;
                previousMajor = parseInt(previousNextjsVersion.split('.')[0]);
                
                logger.info(`å‰å›ã®Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${previousNextjsVersion} (ãƒ¡ã‚¸ãƒ£ãƒ¼: ${previousMajor})`);
              } catch (error) {
                logger.warn(`å‰å›ã®package.jsonãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ: ${error.message}`);
                // åˆå›ã‚³ãƒŸãƒƒãƒˆã®å ´åˆã¯å‰å›ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã—ã¨ã—ã¦å‡¦ç†
              }

              // ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
              const shouldCreateNextjsTag = previousMajor !== null && currentMajor !== previousMajor;
              const nextjsTag = `nextjs-${currentMajor}`;

              if (shouldCreateNextjsTag) {
                logger.success(`Next.jsãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ: ${previousMajor} â†’ ${currentMajor}`);
                logger.success(`Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’ä½œæˆã—ã¾ã™: ${nextjsTag}`);
              } else {
                logger.info('Next.jsãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“');
              }

              core.setOutput('should_create_tag', shouldCreateNextjsTag);
              core.setOutput('tag', nextjsTag);
              core.setOutput('current_version', currentNextjsVersion);
              core.setOutput('previous_version', previousNextjsVersion || 'ãªã—');

              return {
                shouldCreateTag: shouldCreateNextjsTag,
                tag: nextjsTag,
                currentVersion: currentNextjsVersion,
                previousVersion: previousNextjsVersion
              };
            } catch (error) {
              logger.error(`Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
              throw error;
            }

      - name: ğŸ·ï¸ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ä½œæˆ
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const logger = {
              info: (msg) => console.log(`[INFO] ğŸ”µ ${msg}`),
              success: (msg) => console.log(`[SUCCESS] ğŸŸ¢ ${msg}`)
            };

            const tagName = '${{ steps.calendar-version.outputs.tag }}';
            
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tagName}`,
              sha: context.sha
            });

            logger.success(`ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’ä½œæˆã—ã¾ã—ãŸ: ${tagName}`);

      - name: ğŸ·ï¸ Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ä½œæˆ
        if: steps.nextjs-version.outputs.should_create_tag == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const logger = {
              info: (msg) => console.log(`[INFO] ğŸ”µ ${msg}`),
              success: (msg) => console.log(`[SUCCESS] ğŸŸ¢ ${msg}`)
            };

            const tagName = '${{ steps.nextjs-version.outputs.tag }}';
            
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tagName}`,
                sha: context.sha
              });
              logger.success(`Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’ä½œæˆã—ã¾ã—ãŸ: ${tagName}`);
            } catch (error) {
              if (error.status === 422) {
                logger.info(`ã‚¿ã‚° ${tagName} ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ã‚³ãƒŸãƒƒãƒˆã‚’æ›´æ–°ã—ã¾ã™ã€‚`);
                await github.rest.git.updateRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `tags/${tagName}`,
                  sha: context.sha
                });
                logger.success(`Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’æ›´æ–°ã—ã¾ã—ãŸ: ${tagName}`);
              } else {
                throw error;
              }
            }

      - name: ğŸ“ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆãƒ»å…¬é–‹
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const logger = {
              info: (msg) => console.log(`[INFO] ğŸ”µ ${msg}`),
              success: (msg) => console.log(`[SUCCESS] ğŸŸ¢ ${msg}`)
            };

            const calendarTag = '${{ steps.calendar-version.outputs.tag }}';
            const nextjsVersionInfo = JSON.parse('${{ steps.nextjs-version.outputs.result }}');
            
            // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®æœ¬æ–‡ã‚’ä½œæˆ
            let releaseBody = '';

            if (nextjsVersionInfo.shouldCreateTag) {
              releaseBody += `## ğŸ‰ Next.jsãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ\n\n`;
              releaseBody += `Next.jsã®ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ:\n`;
              releaseBody += `- **å‰å›**: \`${nextjsVersionInfo.previousVersion}\`\n`;
              releaseBody += `- **ä»Šå›**: \`${nextjsVersionInfo.currentVersion}\`\n`;
              releaseBody += `- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°**: \`${nextjsVersionInfo.tag}\`\n\n`;
            }

            // GitHubã®è‡ªå‹•ç”Ÿæˆãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: calendarTag,
              name: `Release ${calendarTag}`,
              body: releaseBody,
              generate_release_notes: true,
              draft: false,
              prerelease: false
            });

            logger.success(`ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã—ãŸ: ${release.data.html_url}`);
            
            return {
              releaseUrl: release.data.html_url,
              releaseId: release.data.id
            };
