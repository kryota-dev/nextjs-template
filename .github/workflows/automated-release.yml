name: ğŸš€ Automated Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: ğŸš€ Create Release
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      issues: write

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: ğŸ”¨ Setup pnpm
        uses: ./.github/actions/pnpm-setup

      - name: ğŸ“… Generate calendar version tag
        id: calendar-version
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const logger = {
              info: (msg) => console.log(`[INFO] ğŸ”µ ${msg}`),
              warn: (msg) => console.warn(`[WARN] ğŸŸ¡ ${msg}`),
              error: (msg) => console.error(`[ERROR] ğŸ”´ ${msg}`),
              success: (msg) => console.log(`[SUCCESS] ğŸŸ¢ ${msg}`)
            };

            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’YYYY.MM.DDå½¢å¼ã§å–å¾—ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰
            const today = new Date().toLocaleDateString('ja-JP', {
              timeZone: 'Asia/Tokyo',
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
            }).replace(/\//g, '.');
            logger.info(`ä»Šæ—¥ã®æ—¥ä»˜: ${today}`);

            // æ—¢å­˜ã®ã‚¿ã‚°ä¸€è¦§ã‚’å–å¾—
            const existingTags = await github.paginate(github.rest.repos.listTags, {
              owner: context.repo.owner,
              repo: context.repo.repo
            }).catch(error => {
              logger.error(`ã‚¿ã‚°ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error}`);
              throw error;
            });

            // ä»Šæ—¥ã®æ—¥ä»˜ã§å§‹ã¾ã‚‹ã‚¿ã‚°ã‚’æ¤œç´¢
            const todayTags = existingTags.filter(tag => tag.name.startsWith(today));
            logger.info(`ä»Šæ—¥ã®ã‚¿ã‚°æ•°: ${todayTags.length}`);

            // æ–°ã—ã„ã‚¿ã‚°åã‚’æ±ºå®š
            let newTag = today;
            if (todayTags.length > 0) {
              // åŒæ—¥ã«è¤‡æ•°ã®ãƒªãƒªãƒ¼ã‚¹ãŒã‚ã‚‹å ´åˆã€ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ 
              const maxCount = Math.max(...todayTags.map(tag => {
                const parts = tag.name.split('-');
                return parts.length > 1 ? parseInt(parts[1]) || 0 : 0;
              }));
              newTag = `${today}-${maxCount + 1}`;
            }

            logger.success(`æ–°ã—ã„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°: ${newTag}`);
            core.setOutput('tag', newTag);
            return newTag;

      - name: ğŸ” Check Next.js version change
        id: nextjs-version
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const logger = {
              info: (msg) => console.log(`[INFO] ğŸ”µ ${msg}`),
              warn: (msg) => console.warn(`[WARN] ğŸŸ¡ ${msg}`),
              error: (msg) => console.error(`[ERROR] ğŸ”´ ${msg}`),
              success: (msg) => console.log(`[SUCCESS] ğŸŸ¢ ${msg}`)
            };

            const fs = require('fs');

            try {
              // ç¾åœ¨ã®package.jsonã‹ã‚‰Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
              const currentPackageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              const currentNextjsVersion = currentPackageJson.dependencies.next;
              const currentMajor = parseInt(currentNextjsVersion.split('.')[0]);
              
              logger.info(`ç¾åœ¨ã®Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${currentNextjsVersion} (ãƒ¡ã‚¸ãƒ£ãƒ¼: ${currentMajor})`);

              // æ—¢å­˜ã®nextjs-{version}ã‚¿ã‚°ã‚’å–å¾—
              const existingTags = await github.paginate(github.rest.repos.listTags, {
                owner: context.repo.owner,
                repo: context.repo.repo
              }).catch(error => {
                logger.error(`ã‚¿ã‚°ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error}`);
                throw error;
              });

              // nextjs-{version}ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚¿ã‚°ã‚’æŠ½å‡ºã—ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã§ã‚½ãƒ¼ãƒˆ
              const nextjsTags = existingTags
                .filter(tag => tag.name.startsWith('nextjs-'))
                .map(tag => {
                  const version = parseInt(tag.name.replace('nextjs-', ''));
                  return { name: tag.name, version: version };
                })
                .filter(tag => !isNaN(tag.version))
                .sort((a, b) => b.version - a.version); // é™é †ã‚½ãƒ¼ãƒˆï¼ˆæœ€æ–°ãŒå…ˆé ­ï¼‰

              let previousMajor = null;
              let shouldCreateNextjsTag = false;

              if (nextjsTags.length > 0) {
                previousMajor = nextjsTags[0].version;
                logger.info(`æœ€æ–°ã®Next.jsã‚¿ã‚°: ${nextjsTags[0].name} (ãƒ¡ã‚¸ãƒ£ãƒ¼: ${previousMajor})`);
                shouldCreateNextjsTag = currentMajor !== previousMajor;
              } else {
                logger.info('æ—¢å­˜ã®Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                shouldCreateNextjsTag = true; // åˆå›ä½œæˆ
              }

              const nextjsTag = `nextjs-${currentMajor}`;

              if (shouldCreateNextjsTag) {
                if (previousMajor !== null) {
                  logger.success(`Next.jsãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ: ${previousMajor} â†’ ${currentMajor}`);
                } else {
                  logger.success(`åˆå›Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’ä½œæˆã—ã¾ã™: ${currentMajor}`);
                }
                logger.success(`Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’ä½œæˆã—ã¾ã™: ${nextjsTag}`);
              } else {
                logger.info('Next.jsãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“');
              }

              core.setOutput('should_create_tag', shouldCreateNextjsTag);
              core.setOutput('tag', nextjsTag);
              core.setOutput('current_version', currentNextjsVersion);
              core.setOutput('previous_version', previousMajor ? `nextjs-${previousMajor}` : 'ãªã—');

              return {
                shouldCreateTag: shouldCreateNextjsTag,
                tag: nextjsTag,
                currentVersion: currentNextjsVersion,
                previousVersion: previousMajor ? `nextjs-${previousMajor}` : 'ãªã—'
              };
            } catch (error) {
              logger.error(`Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
              throw error;
            }

      - name: ğŸ·ï¸ Create calendar version tag
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const logger = {
              info: (msg) => console.log(`[INFO] ğŸ”µ ${msg}`),
              success: (msg) => console.log(`[SUCCESS] ğŸŸ¢ ${msg}`)
            };

            const tagName = '${{ steps.calendar-version.outputs.tag }}';
            
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tagName}`,
              sha: context.sha
            });

            logger.success(`ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’ä½œæˆã—ã¾ã—ãŸ: ${tagName}`);

      - name: ğŸ·ï¸ Create Next.js version tag
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const logger = {
              info: (msg) => console.log(`[INFO] ğŸ”µ ${msg}`),
              success: (msg) => console.log(`[SUCCESS] ğŸŸ¢ ${msg}`)
            };

            const nextjsVersionInfo = JSON.parse('${{ steps.nextjs-version.outputs.result }}');
            const tagName = nextjsVersionInfo.tag;
            
            logger.info(`Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã®å‡¦ç†: ${tagName}`);
            
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tagName}`,
                sha: context.sha
              });
              logger.success(`Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’ä½œæˆã—ã¾ã—ãŸ: ${tagName}`);
            } catch (error) {
              if (error.status === 422) {
                logger.info(`ã‚¿ã‚° ${tagName} ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ã‚³ãƒŸãƒƒãƒˆã‚’æ›´æ–°ã—ã¾ã™ã€‚`);
                await github.rest.git.updateRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `tags/${tagName}`,
                  sha: context.sha
                });
                logger.success(`Next.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’æ›´æ–°ã—ã¾ã—ãŸ: ${tagName}`);
              } else {
                throw error;
              }
            }

      - name: ğŸ“ Create release note and publish
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const logger = {
              info: (msg) => console.log(`[INFO] ğŸ”µ ${msg}`),
              success: (msg) => console.log(`[SUCCESS] ğŸŸ¢ ${msg}`)
            };

            const calendarTag = '${{ steps.calendar-version.outputs.tag }}';
            const nextjsVersionInfo = JSON.parse('${{ steps.nextjs-version.outputs.result }}');
            
            // ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®æœ¬æ–‡ã‚’ä½œæˆ
            let releaseBody = '';

            if (nextjsVersionInfo.shouldCreateTag) {
              releaseBody += `## ğŸ‰ Next.jsãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ\n\n`;
              releaseBody += `Next.jsã®ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ:\n`;
              releaseBody += `- **å‰å›**: \`${nextjsVersionInfo.previousVersion}\`\n`;
              releaseBody += `- **ä»Šå›**: \`${nextjsVersionInfo.currentVersion}\`\n`;
              releaseBody += `- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°**: \`${nextjsVersionInfo.tag}\`\n\n`;
            }

            // GitHubã®è‡ªå‹•ç”Ÿæˆãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: calendarTag,
              name: `Release ${calendarTag}`,
              body: releaseBody,
              generate_release_notes: true,
              draft: false,
              prerelease: false
            });

            logger.success(`ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã—ãŸ: ${release.data.html_url}`);
            
            return {
              releaseUrl: release.data.html_url,
              releaseId: release.data.id
            };
