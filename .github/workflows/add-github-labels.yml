name: ğŸ·ï¸ GitHubãƒ©ãƒ™ãƒ«è¿½åŠ 

on:
  push:
    branches:
      - develop
    paths:
      - '.github/labels.yml'
      - '.github/workflows/add-github-labels.yml'
  workflow_dispatch:

jobs:
  add-labels:
    name: ğŸ·ï¸ ãƒ©ãƒ™ãƒ«è¿½åŠ 
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      issues: write

    steps:
      - name: ğŸ” ãƒ–ãƒ©ãƒ³ãƒãƒã‚§ãƒƒã‚¯
        run: |
          if [ "${{ github.ref_name }}" != "develop" ]; then
            echo "âŒ ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ develop ãƒ–ãƒ©ãƒ³ãƒã§ã®ã¿å®Ÿè¡Œå¯èƒ½ã§ã™"
            echo "ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
            exit 1
          fi

      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: ğŸ“¦ Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '22.16.0'

      - name: ğŸ”§ yamlãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g yaml

      - name: ğŸ·ï¸ ãƒ©ãƒ™ãƒ«è¿½åŠ 
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: | #```typescript
            const fs = require('fs');
            const path = require('path');
            const yaml = require('yaml');

            // ãƒ­ã‚¬ãƒ¼ã®å®šç¾©
            const logger = {
              info: (msg, label) => console.log(`[INFO] ğŸ”µ ${formatLabel(label)} ${msg}`),
              warn: (msg, label) => console.warn(`[WARN] ğŸŸ¡ ${formatLabel(label)} ${msg}`),
              error: (msg, label) => console.error(`[ERROR] ğŸ”´ ${formatLabel(label)} ${msg}`),
              success: (msg, label) => console.log(`[SUCCESS] ğŸŸ¢ ${formatLabel(label)} ${msg}`)
            };

            // ãƒ©ãƒ™ãƒ«æƒ…å ±ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const formatLabel = (label) => {
              if (!label) return '';
              const color = label.color ?? '';
              return `[${label.name}${color ? ` (#${color})` : ''}]`;
            };

            // ãƒ©ãƒ™ãƒ«å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
            const labelsPath = path.join(process.env.GITHUB_WORKSPACE, '.github', 'labels.yml');
            const labelsFile = yaml.parse(fs.readFileSync(labelsPath, 'utf8'));
            const { labels } = labelsFile;

            // ãƒ©ãƒ™ãƒ«å®šç¾©ã«å¤‰æ›´ãŒã‚ã£ãŸã‹ã©ã†ã‹ã‚’è¿½è·¡
            let hasChanges = false;

            // æ—¢å­˜ã®ãƒ©ãƒ™ãƒ«ä¸€è¦§ã‚’å–å¾—
            const existingLabels = await github.paginate(github.rest.issues.listLabelsForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo
            }).catch(error => {
              logger.error(`ãƒ©ãƒ™ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error}`);
              throw error;
            });

            // labels.ymlã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãƒ©ãƒ™ãƒ«ã®IDã‚’é›†ã‚ã‚‹
            const definedLabelIds = labels.map(label => label.id).filter(Boolean);

            // æ—¢å­˜ã®ãƒ©ãƒ™ãƒ«ã®ã†ã¡ã€labels.ymlã«å®šç¾©ã•ã‚Œã¦ã„ãªã„ã‚‚ã®ã‚’å‰Šé™¤
            for (const existingLabel of existingLabels) {
              if (!definedLabelIds.includes(existingLabel.id)) {
                await github.rest.issues.deleteLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: existingLabel.name
                }).then(() => {
                  logger.success('ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', existingLabel);
                  hasChanges = true;
                }).catch(error => {
                  logger.error(`ãƒ©ãƒ™ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error}`, existingLabel);
                });
              }
            }

            // æ–°ã—ã„ãƒ©ãƒ™ãƒ«ã®ä½œæˆã¾ãŸã¯æ›´æ–°
            for (const label of labels) {
              try {
                // æ—¢å­˜ã®ãƒ©ãƒ™ãƒ«ã‚’IDã§æ¤œç´¢
                const existingLabel = existingLabels.find(l => l.id === label.id);

                if (existingLabel) {
                  // å¤‰æ›´ãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯
                  const changes = [];
                  // è‰²ã‚³ãƒ¼ãƒ‰ã‚’å°æ–‡å­—ã«æ­£è¦åŒ–ï¼ˆGitHubã®APIã¯å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„ï¼‰
                  const normalizedLabelColor = label.color?.toLowerCase();
                  const normalizedExistingColor = existingLabel.color?.toLowerCase();
                  if (existingLabel.name !== label.name) changes.push(`åå‰ã‚’ "${label.name}" ã«å¤‰æ›´`);
                  if (normalizedExistingColor !== normalizedLabelColor) changes.push(`è‰²ã‚’ "#${label.color}" ã«å¤‰æ›´`);
                  if (existingLabel.description !== label.description) changes.push(`èª¬æ˜ã‚’ "${label.description}" ã«å¤‰æ›´`);

                  if (changes.length > 0) {
                    // å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿æ›´æ–°
                    await github.rest.issues.updateLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      name: existingLabel.name,
                      new_name: label.name,
                      color: label.color,
                      description: label.description
                    });
                    logger.success(
                      `${changes.join('ã€')}ã—ã€æ›´æ–°ã—ã¾ã—ãŸ`,
                      { ...existingLabel, newValues: { name: label.name, color: label.color, description: label.description } }
                    );
                  } else {
                    logger.info('å¤‰æ›´ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“', label);
                  }
                } else {
                  // å­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
                  logger.info('ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆã—ã¾ã™', label);
                  if (label.id) {
                    const oldId = label.id;
                    delete label.id;
                    logger.warn(`æ—¢å­˜ã®ãƒ©ãƒ™ãƒ«ã«å­˜åœ¨ã—ãªã„ID (${oldId}) ãŒè¨­å®šã•ã‚Œã¦ã„ãŸãŸã‚ã€å‰Šé™¤ã—ã¾ã—ãŸ`, label);
                  }
                  const response = await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ...label
                  });
                  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰IDã‚’å–å¾—ã—ã¦ãƒ©ãƒ™ãƒ«å®šç¾©ã«è¿½åŠ 
                  label.id = response.data.id;
                  logger.success('ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ', label);
                  hasChanges = true;
                }
              } catch (error) {
                logger.error(`å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message || error}`, label);
                if (error.status === 422) {
                  logger.warn('APIã®åˆ¶é™ã«ã‚ˆã‚Šå‡¦ç†ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ', label);
                }
              }
            }

            // å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãæˆ»ã™
            if (hasChanges) {
              fs.writeFileSync(labelsPath, yaml.stringify(labelsFile, {
                defaultStringType: 'QUOTE_SINGLE',
                defaultKeyType: 'PLAIN'
              }));
              logger.info('ãƒ©ãƒ™ãƒ«å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            } else {
              logger.info('ãƒ©ãƒ™ãƒ«å®šç¾©ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }
          #```

      - name: ğŸ’¾ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          # Note: the following account information will not work on GHES
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [[ -n "$(git status --porcelain .github/labels.yml)" ]]; then
            git add .github/labels.yml
            git commit -m "ğŸ¤– [CI] ãƒ©ãƒ™ãƒ«ã®IDã‚’æ›´æ–°"
            git push
          else
            echo "labels.ymlã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
          fi
