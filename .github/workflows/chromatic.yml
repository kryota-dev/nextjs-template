name: ðŸŒˆ Chromatic

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, closed]
    paths:
      - '.storybook/**'
      - 'src/**/*.tsx'
      - 'src/**/*.css'
      - 'package.json'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  chromatic:
    name: ðŸŒˆ Chromatic
    runs-on: ubuntu-24.04
    # renovateã®PRã¯Chromaticã‚’å®Ÿè¡Œã—ãªã„
    if: ${{ !startsWith(github.head_ref, 'renovate/') }}
    steps:
      - name: á›˜ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: ðŸ”¨ pnpmã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: ./.github/actions/pnpm-setup

      - name: ðŸŒˆ Chromatic
        uses: chromaui/action@d7afd50124cf4f337bcd943e7f45cfa85a5e4476 # v12.0.0
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          buildScriptName: 'build:storybook'
          # ãƒ–ãƒ©ãƒ³ãƒåã®è¨­å®š:
          # - workflow_dispatchã®å ´åˆ: ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒå(github.ref_name)ã‚’ä½¿ç”¨
          # - PRãŒãƒžãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆ: ãƒžãƒ¼ã‚¸å…ˆã®ãƒ–ãƒ©ãƒ³ãƒå(base.ref)ã‚’ä½¿ç”¨
          # - ãã®ä»–ã®PRã‚¤ãƒ™ãƒ³ãƒˆ: PRã®ãƒ–ãƒ©ãƒ³ãƒå(head_ref)ã‚’ä½¿ç”¨
          branchName: >-
            ${{
              github.event_name == 'workflow_dispatch'
                && github.ref_name
                || (github.event.pull_request.merged
                    && github.event.pull_request.base.ref
                    || github.head_ref)
            }}
